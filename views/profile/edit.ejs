<%- include("../partials/head.ejs") %>
<body>
  <%- include('../partials/nav.ejs') %>

  <nav aria-label="Breadcrumb" class="mb-3 d-flex justify-content-between">
    <a
      class="icon-link icon-link-hover"
      href="/profile"
      aria-label="Back to Profile page"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="bi"
        viewBox="0 0 16 16"
        width="16"
        height="16"
        fill="currentColor"
        role="img"
        focusable="false"
        aria-hidden="true"
      >
        <title>Back</title>
        <path
          fill-rule="evenodd"
          d="M15 8a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 7.5H14.5a.5.5 0 0 1 .5.5z"
        />
      </svg>
      <span>Back to Profile page</span>
    </a>
  </nav>
  <main class="container" role="main" aria-labelledby="edit-profile-title">
    <div class="card mx-auto my-5 profile-form shadow-sm">
      <div class="card-body">
        <h2 id="edit-profile-title" class="card-title mb-4 text-center">
          Edit Profile
        </h2>
        <form
          action="/profile/update"
          method="POST"
          enctype="multipart/form-data"
          novalidate
          aria-describedby="aboutCharCount aboutHelp"
        >
          <div class="mb-3">
            <label for="firstName" class="form-label">First name</label>
            <input
              type="text"
              id="firstName"
              name="firstName"
              value="<%= profile.firstName %>"
              class="form-control"
              required
              aria-required="true"
              aria-describedby="firstNameHelp"
            />
          </div>

          <div class="mb-3">
            <label for="lastName" class="form-label">Last name</label>
            <input
              type="text"
              id="lastName"
              name="lastName"
              value="<%= profile.lastName %>"
              class="form-control"
              required
              aria-required="true"
              aria-describedby="lastNameHelp"
            />
          </div>

          <div class="mb-3">
            <label for="image" class="form-label"
              >Profile image (optional)</label
            >
            <input
              type="file"
              id="image"
              name="image"
              class="form-control"
              accept="image/*"
              aria-describedby="imageHelp"
            />
            <div
              id="image-error"
              class="invalid-feedback"
              role="alert"
              aria-live="assertive"
            ></div>
          </div>

          <% if (profile.image && profile.image.filename) { %>
          <div class="mb-3 text-center">
            <img
              id="preview-image"
              src="/uploads/<%= profile.image.filename %>"
              alt="Current profile image"
              class="profile-img-thumbnail img-thumbnail rounded-circle"
            />
          </div>
          <% } %>

          <div class="mb-4">
            <label for="about" class="form-label">About me</label>
            <textarea
              class="form-control"
              id="about"
              name="about"
              rows="3"
              required
              maxlength="200"
              aria-required="true"
              aria-describedby="aboutCharCount aboutHelp"
              data-about='<%- JSON.stringify(profile.about || "") %>'
            ></textarea>
            <div class="d-flex justify-content-end">
              <span
                class="form-text text-end d-block small text-muted"
                id="aboutCharCount"
                aria-live="polite"
                aria-atomic="true"
              ></span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100">Update</button>
        </form>
      </div>
    </div>
  </main>

  <%- include('../partials/footer.ejs') %>
</body>

<script>
  const MAX_FILE_SIZE_MB = 5; // Max size in MB
  const imageInput = document.getElementById("image");
  const imageError = document.getElementById("image-error");
  const previewImage = document.getElementById("preview-image");
  const removeBtn = document.getElementById("remove-image");

  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];

    if (file) {
      const fileSizeMB = file.size / (1024 * 1024);

      if (fileSizeMB > MAX_FILE_SIZE_MB) {
        imageError.textContent = `File size must be less than ${MAX_FILE_SIZE_MB} MB`;
        imageInput.classList.add("is-invalid");
        imageInput.setAttribute("aria-invalid", "true");
        imageInput.value = "";
      } else {
        imageInput.classList.remove("is-invalid");
        imageInput.setAttribute("aria-invalid", "false");
        imageError.textContent = "";
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
      };
      reader.readAsDataURL(file);
    } else {
      previewImage.src = "";
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    const about = document.getElementById("about");
    const rawValue = about.dataset.about;

    try {
      about.value = JSON.parse(rawValue);
    } catch (err) {
      console.error("Invalid JSON in data-about:", err);
    }

    const aboutCharCount = document.getElementById("aboutCharCount");
    aboutCharCount.textContent = `${about.value.length}/200`;

    about.addEventListener("input", () => {
      aboutCharCount.textContent = `${about.value.length}/200`;
    });
  });
</script>
