<%- include("../partials/head.ejs") %>
<body>
  <%- include('../partials/nav.ejs') %>

  <main
    class="container pt-2 pb-5 blogs"
    role="main"
    aria-label="Blog posts list"
  >
    <div class="row mb-3"><%- include("./createModal") %></div>
    <div class="row g-4">
      <% if (blogs.length > 0) { %> <% blogs.forEach(blog => { %>
      <article class="col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm hover-shadow-lg d-flex flex-column">
          <a
            href="/blogs/<%= blog._id %>"
            class="text-decoration-none text-dark flex-grow-1"
            aria-describedby="desc-<%= blog._id %>"
          >
            <% if (blog?.image?.filename) { %>
            <img
              src="/uploads/<%= blog.image.filename %>"
              class="card-img-top custom-img-height"
              alt="Image for blog titled <%= blog.title %>"
              loading="lazy"
            />
            <% } else { %>
            <img
              src="/images/blog-default-placeholder.jpg"
              class="card-img-top custom-img-height"
              alt="Image for blog titled <%= blog.title %>"
              loading="lazy"
            />

            <% } %>
            <div class="card-body">
              <h2 class="card-title h5"><%= blog.title %></h2>
              <p
                id="desc-<%= blog._id %>"
                class="card-text text-muted custom-blog-body-height"
              >
                <%= blog.body.length > 100 ? blog.body.substring(0, 100) + '...'
                : blog.body %>
              </p>
            </div>
          </a>

          <% if (blog.approvalStatus === "approved") { %>
          <div
            class="px-3 pb-2 d-flex justify-content-end gap-2"
            role="group"
            aria-label="Blog interaction buttons"
          >
            <div class="d-flex align-items-center gap-2">
              <button
                class="btn btn-outline-danger btn-sm d-flex align-items-center gap-1 like-dislike-button"
                data-id="<%= blog._id %>"
                data-type="<%= (blog.likes.map(like =>
            like.toString()).includes(currentProfileId)) ? "dislike" : "like" %>"
                aria-label="<%= blog.likes.includes(user._id) ? 'Unlike' : 'Like' %> this blog"
                aria-pressed="<%= blog.likes.includes(user._id) %>"
              >
                <% if (blog.likes.includes(user._id)) { %>
                <i class="bi bi-heart-fill text-danger" aria-hidden="true"></i>
                <% } else { %>
                <i class="bi bi-heart" aria-hidden="true"></i>
                <% } %>
                <span
                  ><%= blog.likes.length %> Like<%= blog.likes.length === 1 ? ''
                  : 's' %></span
                >
              </button>
            </div>
            <%- include('./commentModal.ejs', { comments: blog.comments, blogId: blog._id }) %> 
          </div>
          <% } %>

          <footer
            class="card-footer d-flex flex-wrap justify-content-between align-items-center small text-muted mt-auto m-0"
          >
            <time datetime="<%= blog.createdAt.toISOString() %>">
              <%= new Date(blog.createdAt).toLocaleDateString('en-US', { year:
              'numeric', month: 'short', day: 'numeric' }) %>
            </time>
            <span
              ><%= blog.profile.firstName %> <%= blog.profile.lastName %></span
            >
            <% if (blog.approvalStatus === "pending") { %>
            <span
              class="badge bg-warning text-dark"
              aria-label="Approval status: pending"
              ><%= blog.approvalStatus %></span
            >
            <% } else if (blog.approvalStatus === "approved") { %>
            <span
              class="badge bg-success"
              aria-label="Approval status: approved"
              ><%= blog.approvalStatus %></span
            >
            <% } else { %>
            <span class="badge bg-danger" aria-label="Approval status: rejected"
              ><%= blog.approvalStatus %></span
            >
            <% } %>
          </footer>
        </div>
      </article>
      <% }) %> <% } else { %>
      <div class="col-12">
        <div class="alert alert-info text-center" role="alert">
          There are no blogs to display.
        </div>
      </div>
      <% } %>
    </div>
  </main>

  <%- include('../partials/footer.ejs') %>

  <script>
    const commentModals = document.querySelectorAll(".commentModal");
    const addComment = (comment, modal) => {
      const modalFooter = modal.querySelector(".modal-footer");
      
      let commentList = modalFooter.querySelector(".d-flex.flex-column");
      const noCommentsPlaceholder = modalFooter.querySelector(".text-muted");
      
      if (!commentList) {
        noCommentsPlaceholder.remove();
        commentList = document.createElement("div");
        commentList.className = "d-flex flex-column w-100";
        modalFooter.append(commentList);
      }

      // Create the comment card
      const commentCard = document.createElement("div");
      commentCard.className = "card mb-2 w-100 animate__animated animate__fadeInDown";
      commentCard.style.backgroundColor = "#e9f5ff";

      commentCard.innerHTML = `
        <div class="card-body d-flex align-items-start">
          <img
            src="/uploads/${comment.author.image.filename}"
            alt="Profile Image of ${comment.author.firstName} ${comment.author.lastName}"
            class="rounded-circle shadow me-3"
            style="width: 40px; height: 40px; object-fit: cover"
          />
          <div class="flex-grow-1">
            <div class="d-flex mb-1 fw-bold w-100">
              <p class="mb-0">${comment.author.firstName} ${comment.author.lastName}</p>
              <small class="ms-auto text-muted">
                ${new Date(comment.createdAt).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </small>
            </div>
            <p class="mb-0">${comment.content}</p>
          </div>
        </div>
      `;

      commentList.prepend(commentCard);
      modal.querySelector("form").reset();
    };

    commentModals.forEach(modal => {
      const form = modal.querySelector("form");
      form.addEventListener("submit",  async (e) => {
        e.preventDefault();

        try {
          const result = await fetch("/api/comment", {
            method: "POST",
            body: JSON.stringify({
              content: form.content.value,
              blogId: form.blogId.value
            }),
            headers: {
              "Content-Type": "application/json"
            }
          })
          
          if (!result.ok){
            throw new Error("Can't save comment!")
          }
          const { newComment } = await result.json()
          addComment(newComment, modal);
        } catch (err) {
          // TODO: Show toast here!
          console.log("Error while saving the comment", err.message)
        }
      })
    })
    
    document.addEventListener("DOMContentLoaded", () => {
      const likeDislikeButtons = document.querySelectorAll(".like-dislike-button");
      const likeButtons = document.querySelectorAll(".like-button");
      const dislikeButtons = document.querySelectorAll(".dislike-button");

      likeDislikeButtons.forEach(button => {
        button.addEventListener("click", async() => {
          const type = button.dataset.type;
          const blogId = button.dataset.id;
          
          try {
            const res = await fetch(`/api/blogs/${blogId}/${type}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });
            if (res.ok) {
              // TODO: Toggle UI state
              location.reload();
            }
          } catch(err) {
            console.log(`Failed to ${type} blog`, err.message)
          }
        })
      })
    });
  </script>
</body>
